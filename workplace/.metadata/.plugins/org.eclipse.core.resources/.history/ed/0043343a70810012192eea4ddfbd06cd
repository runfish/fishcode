<%@ page language="java" import="java.util.*" pageEncoding="utf-8"%>
<%@page import="net.dfrz.supershop01.listener.OnLineUserListener"%>
<%@ include file="/jsps/common/taglibs.jsp"%>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    
    <title>超市商品管理系统</title>   
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="expires" content="0">    
	<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
	<meta http-equiv="description" content="This is my page">
	
	<link rel="stylesheet" type="text/css" href="<c:url value="/css/application.css"/>">
	<script type="text/javascript" src="jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="<c:url value="/js/prototype.js"/>"></script>
<script type="text/javascript">
	
    var seed= Math.random();
    //系统时间数组
    var time=new Array();
    //管理员用户是否存在的标志
    var exist=true;
    var userName='${sessionScope.admin.administratorName}';
    
	function logout(){
	  if(confirm('尊敬的${sessionScope.admin.administratorName},您真的要离开系统吗？')){
	     location.href="<c:url value="/action/securityMgr?act=logOut"/>";
	    }    
	}
	//获取系统时间
	function getSystemDate()
	{
	  new Ajax.Request(
	  encodeURI("/shop02/action/securityMgr?act=getSystemDate&rand="+Math.random()),
	  {
	  	method:"get",
	  	onComplete:function(xhr)
	  	{
	  	  if(xhr.responseText!=null)
	      {
	         var systemTime=xhr.responseText;
	         var array=systemTime.split(":");
	         time[0]=parseInt(array[0]);
	         time[1]=parseInt(array[1]);
	         time[2]=parseInt(array[2]);
	         time[3]=parseInt(array[3]);
	         time[4]=parseInt(array[4]);
	         time[5]=parseInt(array[5]);
	         updateDate();
	      }
	  	}
	  }
	  );
	}
	//刷新服务器时间
	function updateDate()
	{   
	     var cTime=document.getElementById("ctime");
	     cTime.innerHTML="";
	     
		 var serviceTime=time[0]+"-"+time[1]+"-"+time[2]+" "
	                     +time[3]+":"+time[4]+":"+time[5]+"&nbsp";
	     cTime.innerHTML=serviceTime;
	     time[5]=time[5]+1;
	     if(time[5]==60)
	     {
	        time[5]=0;
	        time[4]=time[4]+1;
	     }
	     if(time[4]==60)
	     {
	        time[4]=0;
	        time[3]=time[3]+1;
	     }
	     if(time[3]==24)
	     {
	        time[3]=0;
	        time[2]=time[2]+1;
	     }
	}
	//判断管理员用户是否还存在session空间
	function isExist()
	{  
	  if(exist==true)
	  {
		if(${sessionScope.admin==null})
		{  
			exist=false;
		}
	  }
	  if(exist==false)
	  {
	    clearInterval(isExist);
	  	alert("对不起，管理员:"+userName+"已经失去连接清重新登入!");
	  	location.href="<c:url value="/action/securityMgr?act=logOut"/>";
	  }
	}
	//刷新在线人数
	function updateOnlineUserNo()
	{   
	   <%
	     long count=OnLineUserListener.getOnlineUserNo();
	     System.out.println(count);
	   %>
	   
		var userNo=document.getElementById("userno");
		userNo.innerHTML="";
		userNo.innerHTML="在线人数："+<%=count%>+"人&nbsp";
	}
	 var ad=setInterval(isExist,10*60*1000);
	 var sh=setInterval(updateDate,1000); 
	 var user=setInterval(updateOnlineUserNo,1000);
</script>
  </head>
  
  <body style="background:#eae7d7" onload="getSystemDate();">
     <div id="header">
        <div id="productName">电子商务后台管理系统</div>
       <div style="float:right; margin:10px;">
                <span>管理员:${sessionScope.admin.administratorName}&nbsp;</span>
                <span id="userno">在线人数&nbsp;</span>
                <span id="ctime">时间</span>
              <span class="linkspan" onclick="logout();" title="点击离开系统">离开系统</span>
        </div>
     </div>
     <div>
        <div id="navigator">
            <div class="menuitem">
               <a href="<c:url value="/action/categoryMgr?act=input"/>" target="contentFrame">增加类别</a>
            </div>
            <div class="menuitem">
               <a href="<c:url value="/action/categoryMgr?act=loadPageAll"/>"  target="contentFrame">类别管理</a>
            </div>
            <div class="seperator"></div>
            <div class="menuitem">
               <a href="<c:url value="/action/goodsMgr?act=input"/>"  target="contentFrame">新增商品</a>
            </div>
            <div class="menuitem">
               <a href="<c:url value="/action/goodsMgr?act=loadPageGoods"/>"   target="contentFrame">商品查询</a>
            </div>
            <div class="seperator"></div>
            <div class="menuitem">
               <a href="<c:url value="/action/dealMgr?act=loadPageDeal"/>"   target="contentFrame">订单管理</a>
            </div>
            <div class="seperator"></div>
            <div class="menuitem">
               <a href="<c:url value="/action/adminMgr?act=input"/>" target="contentFrame">新增管理员</a>
            </div>
            <div class="menuitem">
               <a href="<c:url value="/action/goodsMgr?act=loadPageGoods"/>"   target="contentFrame">管理员管理</a>
            </div>            
        </div>
       <div id="content">
          <iframe id="contentFrame" width="100%" scrolling="yes" height="480px" frameborder="0" name="contentFrame" allowtransparency="true" src="<c:url value="/welcome.jsp"/>">              
          </iframe>           
        </div>
        <div id="down" style=" padding-top:0px">
         <%@ include file="/jsps/common/footer.jsp"%>
       </div>
     </div>
  </body>
</html>
